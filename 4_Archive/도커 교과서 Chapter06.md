---
title: 도커 교과서 Chapter06
aliases: 
classification: 
tags:
  - docker
created: 2024-02-21 22:26
updated: 2025-01-18T20:16
---

## 도커 볼륨을 이용한 퍼시스턴트 스토리지

### 컨테이너의 파일 시스템

모든 컨테이너는 독립된 파일 시스템을 갖는다.
도커 이미지는 여러 개의 레이어 형태로 저장되고, 컨테이너의 디스크 역시 이 이미지 레이어를 순서대로 합쳐 만든 가상 파일 시스템이다.

컨테이너의 파일 시스템은 단일 디스크다.
- 리눅스 컨테이너는 `/dev/sda1`
- 윈도는 `C:\`
기본적으로 이미지 레이어와 컨테이너의 기록 가능 레이어로 구성되는데, 이미지 레이어는 모든 컨테이너가 공유하지만 기록 가능 레이어는 컨테이너 마다 다르다.
기록 가능 레이어는 컨테이너와 같은 생애주기를 갖는다.
- 컨테이너의 기록 가능 레이어와 여기서 수정된 데이터도 함께 삭제된다.
- 컨테이너가 종료될 때 삭제되는 것이 아니라 삭제될 때 같이 삭제된다.

도커는 copy-on-write(기록 중 복사)라는 방법을 사용해 읽기 전용 레이어의 파일을 수정할 수 있다.
- 컨테이너에서 이미지 레이어에 포함된 파일을 수정하려 하면, 먼저 도커가 이 파일을 쓰기 가능 레이어로 복사해 온 다음 쓰기 가능 레이어에서 파일을 수정한다.

컨테이너 속 파일을 수정하면 컨테이너의 동작에 영향을 미친다. 그러나 이미지를 공유하는 다른 컨테이너나 이미지는 영향을 받지 않는다. 수정된 파일은 해당 컨테이너의 기록 가능 레이어에만 존재하기 때문이다.

### 도커 볼륨

도커 볼륨은 도커에서 스토리지를 다루는 단위다. 컨테이너와 독립적으로 존재하며 별도의 생애주기를 갖지만, 컨테이너에 연결할 수 있다.

컨테이너에서 볼륨을 사용하는 방법
1. 수동으로 직접 볼륨을 생성해 컨테이너에 연결하는 방법
2. Dockerfile 스크립트에서 `VOLUME` instrcution 을 사용하는 방법

다음과 같이 Dockerfile을 작성하고 컨테이너를 실행하면 자동으로 볼륨을 생성해 컨테이너에 연결해 준다.
- /data 디렉토리의 내용은 영구적으로 저장된다.

```Dockerfile
FROM diamol/dotnet-aspnet
WORKDIR /app
ENTRYPOINT ["dotnet", "ToDoList.dll"]

VOLUME /data
COPY --from=builder /out/ .
```

도커 이미지에서 볼륨을 정의하면 컨테이너를 생성할 때마다 새로운 볼륨을 만든다.
volumes-from 플래그를 적용하면 이미 존재하는 볼륨을 연결할 수 있다.
`docker container run -d --name t3 --volumes-from todo1 diamol/ch06-todo-list`

컨테이너는 종종 자신만 접근할 수 있는 파일을 필요로 한다. 이러한 파일을 다른 컨테이너가 동시에 접근하게 허용하면 문제가 발생할 수 있다.
볼륨은 컨테이너 간 파일 공유보다는 업데이트 간 상태를 보존하기 위한 용도로 사용해야 하며, 이미지에서 정의하는 것보다는 명시적으로 관리하는 편이 더 낫다.

--volume(-v) 플래그는 이미지에 볼륨이 정의돼 있든 말든 지정된 볼륨을 컨테이너에 마운트한다. 이미지에 볼륨이 정의돼 있더라도 이 정의가 무시되므로 새로운 볼륨이 생성되지 않는다.

### 파일 시스템 마운트를 사용하는 컨테이너

바인드 마운트(bind mount)는 호스트 컴퓨터 파일 시스템의 디렉터리를 컨테이너 파일 시스템의 디렉터리로 만든다.
바인드 마운트를 사용하면 호스트 컴퓨터의 파일 시스템을 명시적으로 지정해 컨테이너 데이터로 쓸 수 있다.
바인드 마운트는 양방향으로 동작한다.
- 컨테이너에서 만든 파일을 호스트 컴퓨터에서 수정할 수도 있고, 반대로 호스트에서 만든 파일도 컨테이너에서 수정할 수 있다.
- 호스트 컴퓨터에 대한 공격을 방지하기 위해 컨테이너는 대개 최소 권한을 가진 계정으로 실행되는데, 바인드 마운트를 사용하면 호스트 컴퓨터 파일에 접근하기 위해 권한 상승이 필요하다. 그래서 Dockerfile 스크립트에서 USER 인스트럭션을 사용해 컨테이너에 관리자 권한을 부여한다

### 파일 시스템 마운트의 한계점

1. 이미 존재하는 대상 디렉터리에 마운트하면 마운트의 원본 디렉터리가 기존 디렉터리를 완전히 대체한다. 그래서 이미지에 포함돼 있던 원래 파일은 사용할 수 없다.
2. 호스트 컴퓨터의 파일 하나를 컨테이너에 이미 존재하는 디렉터리로 마운트하면 디렉터리의 파일이 합쳐져 이미지에서 온 파일과 호스트에서 마운트된 파일이 모두 나타난다. 
	- 단, 윈도 컨테이너는 이 기능을 제공하지 않아 동작이 달라진다.
	- **컨테이너 파일 시스템은 윈도 컨테이너와 리눅스 컨테이너의 동작이 일치하지 않는 몇 안 되는 영역 중 하나다.**
3. 분산 파일 스토리지를 컨테이너에 마운트하면 일반적인 파일 시스템의 일부처럼 보이기는 하겠지만 지원하지 않는 동작이 있을 수 있다.
	- 매우 드문 케이스

컨테이너에 분산 스토리지를 마운트할 계획이라면, 분산 스토리지의 성능이 로컬 스토리지와 큰 차이가 있다는 것도 고려해야 한다.
디스크를 많이 사용하는 애플리케이션을 분산 스토리지를 마운트한 컨테이너에서 실행한다면 모든 파일 입출력이 네트워크를 거쳐야 하는 만큼 최악의 경우 애플리케이션이 멈춰 버릴 가능성도 있다.

### 컨테이너 파일 시스템 Best Practice

모든 컨테이너는 도커가 다양한 출처로부터 모아 만든 단일 가상 디스크로 구성된 파일 시스템을 갖는다. 이 파일 시스템을 Union File System이라고 한다.

기록 가능 레이어
- 비용이 비싼 계산이나 네트워크를 통해 저장해야 하는 데이터의 캐싱 등 단기 저장에 적합하다.
- 각 컨테이너마다 독립적인 기록 가능 레이어를 갖지만, 컨테이너가 삭제되면 여기 저장된 데이터는 유실된다.
로컬 바인드 마운트
- 호스트 컴퓨터와 컨테이너 간 데이터를 공유하기 위해 사용한다.
- 개발자의 로컬 컴퓨터에서 컨테이너로 소스 코드를 전달하기 위해 사용하면 로컬 컴퓨터에서 수정한 내용이 이미지 빌드 없이도 즉시 컨테이너로 전달될 수 있다.
분산 바인드 마운트
- 네트워크 스토리지와 컨테이너 간에 데이터를 공유하기 위해 사용한다.
- 가용성이 높지만 로컬 디스크와 비교해 지원하지 않는 파일 시스템 기능이 있거나 성능 면에서 차이가 있을 수 있다.
- 읽기전용으로 설정 파일을 전달하거나 공유 캐시로 활용할 수 있으며 읽기 쓰기 가능으로 데이터를 저장해 동일 네트워크상의 모든 컨테이너나 컴퓨터와 데이터를 공유하는 데 적합하다.
볼륨 마운트
- 컨테이너와 도커 객체인 볼륨 간에 데이터를 공유하기 위해 사용된다.
- 볼륨 마운트를 사용하면 애플리케이션이 볼륨에 데이터를 영구적으로 저장한다.
- 컨테이너를 교체하는 방식으로 애플리케이션을 업데이트해도, 이전 버전 컨테이너의 데이터를 그대로 유지할 수 있다.
이미지 레이어
- 이미지 레이어는 컨테이너의 초기 파일 시스템을 구성한다.
- 레이어는 적층 구조를 갖는데, 후속 레이어와 이전 레이어의 내용이 서로 충돌하는 경우 후속 레이어의 내용이 적용된다.
- 레이어는 읽기 전용이며 여러 컨테이너가 공유한다.
![[Pasted image 20240221234740.png]]
